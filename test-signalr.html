<!DOCTYPE html>
<html>
<head>
    <title>SignalR Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@8.0.0/dist/browser/signalr.min.js"></script>
</head>
<body>
    <h1>SignalR Connection Test</h1>
    <div id="status">Connecting...</div>
    <button onclick="sendTestMessage()">Send Test Message</button>
    <div id="messages"></div>

    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("http://localhost:5000/chathub")
            .configureLogging(signalR.LogLevel.Information)
            .build();

        const statusDiv = document.getElementById('status');
        const messagesDiv = document.getElementById('messages');

        // Handle Connected event
        connection.on("Connected", function (data) {
            console.log("Connected with data:", data);
            messagesDiv.innerHTML += `<p>Connected! Session: ${data.sessionId}</p>`;
            statusDiv.innerHTML = "Connected!";
            window.sessionId = data.sessionId;
        });

        // Handle ReceiveMessage event
        connection.on("ReceiveMessage", function (data) {
            console.log("Message received:", data);
            messagesDiv.innerHTML += `<p>Response: ${data.message}</p>`;
        });

        // Handle Processing event
        connection.on("Processing", function (data) {
            console.log("Processing...", data);
            messagesDiv.innerHTML += `<p>Processing...</p>`;
        });

        // Handle Error event
        connection.on("Error", function (error) {
            console.error("Error:", error);
            messagesDiv.innerHTML += `<p style="color:red">Error: ${error}</p>`;
        });

        // Start connection
        connection.start().then(function () {
            console.log("Connection started");
        }).catch(function (err) {
            console.error("Connection failed:", err);
            statusDiv.innerHTML = "Connection failed: " + err;
        });

        function sendTestMessage() {
            if (connection.state === signalR.HubConnectionState.Connected) {
                connection.invoke("SendMessage", "Hello from test page!")
                    .catch(err => console.error("Send failed:", err));
            } else {
                alert("Not connected!");
            }
        }

        // Log connection state changes
        connection.onclose(() => {
            statusDiv.innerHTML = "Disconnected";
            console.log("Connection closed");
        });

        connection.onreconnecting(() => {
            statusDiv.innerHTML = "Reconnecting...";
            console.log("Reconnecting...");
        });

        connection.onreconnected(() => {
            statusDiv.innerHTML = "Reconnected!";
            console.log("Reconnected");
        });
    </script>
</body>
</html>